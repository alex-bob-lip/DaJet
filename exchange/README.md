# Подсистема DaJet Exchange для 1С

Для интеграции решений, реализованных на платформе 1С:Предприятие 8, с внешними информационными системами
разработана небольшая подсистема DaJet Exchange. Идея заключается в том, что внешняя ИС получает
возможность управлять регистрацией изменений в 1С при помощи файла настроек в формате JSON.
1С при этом регистрирует необходимые внешней ИС данные в справочнике - очереди исходящих сообщений,
что позволяет внешней ИС оперативно забирать изменения из справочника 1С (таблицы СУБД).

**1. Установка подсистемы в 1С**

- Объединить конфигурацию DaJetExchange.cf с интегрируемой конфигурацией 1С.
- Указать в константе DaJetExchangeCatalog путь к каталогу файла настроек dajet-exchange-settings.json.
- Загрузить файл настроек dajet-exchange-settings.json в константу DaJetExchangeSettings при помощи обработки DaJetExchangeTest.
- Включить использование подсистемы DaJetExchange при помощи константы UseDaJetExchange.

**2. Файл настроек dajet-exchange-settings.json**

Файл имеет интуитивно понятную структуру. Для того, чтобы 1С регистрировала изменения по интересующим внешнюю ИС объектам,
необходимо настроить раздел файла настроек ChangeTracking. Пример настроечного файла прилагается.
При помощи этого файла можно настроить регистрацию изменений для справочников, документов, их табличных частей,
регистров сведений и накопления. Гранулярность регистрации изменений можно настраивать на уровне объектов и их свойств.
Если объект или его свойства не указаны, то по ним регистрация изменений не выполняется.

Структура файла настроек **dajet-exchange-settings.json**:

- **ConnectionString** - строка подключения к базе данных 1С
- **ExportQueue** - очередь исходящих сообщений
  - Name - наименование справочника 1С - очереди исходящих сообщений
  - Table - таблица СУБД справочника 1С
  - Fields - поля справочника 1С и его таблицы СУБД
    - Name - наименование реквизита справочника 1С
    - Field - имя поля таблицы СУБД
- **ChangeTracking** - настройки регистрации изменений
  - **Catalogs** (настройки для справочников 1С)
    - Properties - свойства объекта
      - Name - наименование свойства объекта
    - TableParts - табличные части
      - Name - наименование табличной части
      - Properties - свойства табличной части
  - **Documents** (настройки для документов 1С)
    - Properties - свойства объекта
      - Name - наименование свойства объекта
    - TableParts - табличные части
      - Name - наименование табличной части
      - Properties - свойства табличной части
  - **InformationRegisters** (настройки для регистров сведений 1С)
    - Properties - свойства объекта
  - **AccumulationRegisters** (настройки для регистров накопления 1С)
    - Properties - свойства объекта

Пример настройки для документа 1С:
```json
{
  "ChangeTracking": {
    "Documents": {
      "ЗаказКлиента": {
        "Properties": [
          { "Name": "Ссылка" },
          { "Name": "Дата" },
          { "Name": "Номер" },
          { "Name": "Проведен" },
          { "Name": "ПометкаУдаления" }
        ],
        "TableParts": [
          {
            "Name": "Товары",
            "Properties": [
              { "Name": "НомерСтроки" },
              { "Name": "Номенклатура" },
              { "Name": "Количество" }
            ]
          }
        ]
      }
    }
  }
}
```

**3. Очередь исходящих сообщений**

Регистрируемые изменения фиксируются в справочнике DaJetExchangeQueue. Этот справочник выполняет роль очереди исходящих сообщений.
Изменения попадают в эту очередь в виде JSON. Все изменения попадают в справочник DaJetExchangeQueue в транзакции СУБД.
То есть если изменение объекта 1С будет отменено, то регистрация изменения, сообщение для внешней системы, не будет зафиксировано.

Справочник имеет следующую структуру:
- **Код** - счётчик сообщений по порядку, генерируется платформой 1С.
- **ДатаВремя** - дата и время регистрации сообщения.
- **ТипОперации** - перечисление строковых значений: INSERT, UPDATE и DELETE.
- **ТипСообщения** - тип объекта 1С, который содержится в сообщении, например, "Документ.ЗаказКлиента".
- **ТелоСообщения** - данные объекта 1С, сериализованные в формате JSON.

Получать данные из этой очереди можно при помощи прямых запросов SQL к таблице справочника или при помощи адаптера,
например, для очередей сообщений RabbitMQ или Kafka.

Пример кода SQL Server для получения сообщений (FIFO strict order required):
```SQL
WITH [CTE] AS
    (
        SELECT TOP(1)
            [_Fld83] AS [ТипОперации],
            [_Fld84] AS [ТипСообщения],
            [_Fld85] AS [ТелоСообщения]
        FROM
            [dbo].[_Reference81] WITH(rowlock)
        ORDER BY
            [_Code] ASC, [_IDRRef] ASC
    )
    DELETE
        [CTE]
    OUTPUT
        deleted.[ТипОперации], deleted.[ТипСообщения], deleted.[ТелоСообщения];

```

**4. Обработка и маршрутизация сообщений**

Подобная схема работы с данными 1С предполагает, что вся логика обработки сообщений,
а также их маршрутизация в различные узлы РИБ (распределённой информационной базы),
если они есть, перекладывается на внешнюю ИС.

В данном случае регистрация изменений 1С будет выполняться максимально быстро и без блокировок СУБД.

**Примеры генерируемого 1С тела сообщения:**

Тип сообщения: **Документ.ЗаказКлиента**
```json
{
  "Ссылка": {
    "type": "DocumentRef.ЗаказКлиента",
    "value": "52e31bfd-9185-11ea-9c65-408d5c93cc8e"
  },
  "Дата": "2021-01-01T00:00:00",
  "Номер": "000011",
  "Проведен": true,
  "ПометкаУдаления": false,
  "Товары": [
    {
      "НомерСтроки": 1,
      "Номенклатура": {
        "type": "CatalogRef.Номенклатура",
        "value": "83193fb5-5037-11eb-9c8e-408d5c93cc8e"
      },
      "Количество": 10
    },
    {
      "НомерСтроки": 2,
      "Номенклатура": {
        "type": "CatalogRef.Номенклатура",
        "value": "83193fb5-5037-11eb-9c8e-408d5c93cc8e"
      },
      "Количество": 20
    }
  ]
}
```

Тип сообщения: **РегистрНакопления.ЗаказыКлиентов**
```json
{
  "Delete": {
    "Регистратор": {
      "type": "DocumentRef.ЗаказКлиента",
      "value": "52e31bfd-9185-11ea-9c65-408d5c93cc8e"
    }
  },
  "Insert": [
    {
      "Период": "2021-01-01T00:00:00",
      "Регистратор": {
        "type": "DocumentRef.ЗаказКлиента",
        "value": "52e31bfd-9185-11ea-9c65-408d5c93cc8e"
      },
      "НомерСтроки": 1,
      "ВидДвижения": {
        "type": "AccumulationRecordType",
        "value": "Receipt"
      },
      "ЗаказКлиента": {
        "type": "DocumentRef.ЗаказКлиента",
        "value": "52e31bfd-9185-11ea-9c65-408d5c93cc8e"
      },
      "Номенклатура": {
        "type": "CatalogRef.Номенклатура",
        "value": "83193fb5-5037-11eb-9c8e-408d5c93cc8e"
      },
      "Количество": 10
    },
    {
      "Период": "2021-01-01T00:00:00",
      "Регистратор": {
        "type": "DocumentRef.ЗаказКлиента",
        "value": "52e31bfd-9185-11ea-9c65-408d5c93cc8e"
      },
      "НомерСтроки": 2,
      "ВидДвижения": {
        "type": "AccumulationRecordType",
        "value": "Receipt"
      },
      "ЗаказКлиента": {
        "type": "DocumentRef.ЗаказКлиента",
        "value": "52e31bfd-9185-11ea-9c65-408d5c93cc8e"
      },
      "Номенклатура": {
        "type": "CatalogRef.Номенклатура",
        "value": "83193fb5-5037-11eb-9c8e-408d5c93cc8e"
      },
      "Количество": 20
    }
  ]
}
```